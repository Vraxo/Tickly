<?xml version="1.0" encoding="utf-8" ?>
<!-- MainPage.xaml -->
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Tickly.ViewModels"
             xmlns:models="clr-namespace:Tickly.Models"
             xmlns:converters="clr-namespace:Tickly.Converters"
             x:Class="Tickly.MainPage"
             BackgroundColor="Black"
             Title="Tickly Tasks">

    <ContentPage.BindingContext>
        <vm:MainViewModel />
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:PriorityToColorConverter x:Key="PriorityColorConverter" />
            <converters:TaskTimeToStringConverter x:Key="TaskTimeConverter" />
            <!-- Style for completed repeating tasks -->
            <Style x:Key="CompletedTaskLabelStyle" TargetType="Label">
                <Setter Property="TextColor" Value="Gray" />
                <Setter Property="TextDecorations" Value="Strikethrough" />
            </Style>
            <!-- Optional: Style CheckBox -->
            <Style TargetType="CheckBox">
                <Setter Property="Color" Value="{StaticResource Primary}"/>
                <Setter Property="VerticalOptions" Value="Center"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*" ColumnDefinitions="*">

        <CollectionView ItemsSource="{Binding Tasks}"
                        CanReorderItems="True"
                        Margin="15,10,15,0"
                        SelectionMode="None">
            <!-- Adjust margin if needed (Comment Correctly Moved) -->

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:TaskItem">
                    <!-- Grid for tappable area (Edit) & Root for Triggers -->
                    <Grid Padding="5, 8">
                        <!-- Reduced Padding slightly (Comment Correctly Moved) -->
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=NavigateToEditPageCommand}"
                                CommandParameter="{Binding .}" />
                        </Grid.GestureRecognizers>

                        <!-- Grid for Item Content Layout -->
                        <Grid ColumnSpacing="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <!-- Priority -->
                                <ColumnDefinition Width="*" />
                                <!-- Text -->
                                <ColumnDefinition Width="Auto" />
                                <!-- CheckBox -->
                            </Grid.ColumnDefinitions>

                            <!-- Priority Indicator -->
                            <Frame Grid.Column="0" HeightRequest="12" WidthRequest="12" CornerRadius="6"
                                   BackgroundColor="{Binding Priority, Converter={StaticResource PriorityColorConverter}}"
                                   VerticalOptions="Center" HorizontalOptions="Center" BorderColor="Transparent"
                                   Padding="0" Margin="0,0,5,0"/>

                            <!-- Task Title and Time -->
                            <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                                <Label x:Name="TitleLabel" Text="{Binding Title}" TextColor="White" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                                <Label x:Name="DateLabel" Text="{Binding ., Converter={StaticResource TaskTimeConverter}}" TextColor="Gray" FontSize="12" VerticalOptions="Center" />
                            </VerticalStackLayout>

                            <!-- CheckBox for Completion - Uses CheckedChanged Event -->
                            <CheckBox Grid.Column="2"
                                      IsChecked="{Binding IsCompleted, Mode=OneWay}"
                                      CheckedChanged="CheckBox_CheckedChanged"
                                      HorizontalOptions="End" />
                            <!-- OneWay binding, command handles logic (Comment Moved) -->
                            <!-- Event handler in code-behind (Comment Moved) -->

                        </Grid>

                        <!-- Triggers moved to the root Grid -->
                        <Grid.Triggers>
                            <!-- Data Triggers for Completed Repeating Tasks -->
                            <DataTrigger TargetType="Label" Binding="{Binding IsCompleted}" Value="True">
                                <!-- Styling applied regardless of type; ViewModel handles actual logic -->
                                <Setter TargetName="TitleLabel" Property="Style" Value="{StaticResource CompletedTaskLabelStyle}" />
                                <Setter TargetName="DateLabel" Property="Style" Value="{StaticResource CompletedTaskLabelStyle}" />
                            </DataTrigger>
                        </Grid.Triggers>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <CollectionView.EmptyView>
                <StackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="20" Spacing="5">
                    <Label Text="No tasks yet!" TextColor="Gray" FontSize="16" HorizontalTextAlignment="Center"/>
                    <Label Text="Click the '+' button to add one." TextColor="Gray" FontSize="14" HorizontalTextAlignment="Center"/>
                </StackLayout>
            </CollectionView.EmptyView>

        </CollectionView>

        <!-- Add Button -->
        <Button Grid.Row="0" Grid.Column="0" Text="+" FontSize="24" FontAttributes="Bold" TextColor="Black"
                BackgroundColor="{StaticResource Primary}" CornerRadius="28" HeightRequest="56" WidthRequest="56"
                HorizontalOptions="End" VerticalOptions="End" Margin="20"
                Command="{Binding NavigateToAddPageCommand}"
                SemanticProperties.Hint="Add a new task"/>

    </Grid>
</ContentPage>