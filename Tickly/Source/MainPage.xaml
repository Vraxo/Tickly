<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Tickly.ViewModels"
             xmlns:model="clr-namespace:Tickly.Models"
             xmlns:converters="clr-namespace:Tickly.Converters"
             xmlns:fonts="clr-namespace:Fonts"
             x:DataType="vm:MainViewModel"
             x:Class="Tickly.MainPage"
             Shell.NavBarIsVisible="False"
             BackgroundColor="{StaticResource PageBackgroundColor}">

    <ContentPage.Resources>
        <converters:PriorityToColorConverter x:Key="PriorityToColorConverter" />
        <converters:TaskTimeToStringConverter x:Key="TaskTimeToStringConverter" />
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter" />
        <converters:FutureRepeatingTaskIsEnabledConverter x:Key="FutureRepeatingTaskIsEnabledConverter" />
        <converters:ProgressToColorConverter x:Key="ProgressToColorConverter" />

        <Style TargetType="Frame" x:Key="TaskCardStyle">
            <Setter Property="BackgroundColor" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Margin" Value="10,5"/>
            <Setter Property="HasShadow" Value="True"/>
            <Setter Property="BorderColor" Value="#e9ecef"/>
            <Setter Property="Opacity" Value="1"/>
            <Style.Triggers>
                <DataTrigger TargetType="Frame"
                             Binding="{Binding IsFadingOut}"
                             Value="True">
                    <Setter Property="Opacity" Value="0"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="Label" x:Key="TaskTitleStyle">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontAttributes" Value="Bold"/>
            <Setter Property="TextColor" Value="#212529"/>
            <Setter Property="LineBreakMode" Value="TailTruncation"/>
        </Style>

        <Style TargetType="Label" x:Key="TaskDetailStyle">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="TextColor" Value="#6c757d"/>
        </Style>

        <Style TargetType="Grid" x:Key="TaskGridStyle">
            <Setter Property="ColumnDefinitions" Value="Auto,*,Auto"/>
            <Setter Property="RowDefinitions" Value="Auto, Auto"/>
            <Setter Property="ColumnSpacing" Value="10"/>
        </Style>

        <DataTemplate x:Key="TaskItemTemplate" x:DataType="model:TaskItem">
            <Frame Style="{StaticResource TaskCardStyle}">
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=NavigateToEditPageCommand}"
                                          CommandParameter="{Binding .}"/>
                </Frame.GestureRecognizers>
                <Grid Style="{StaticResource TaskGridStyle}">
                    <Border StrokeShape="RoundRectangle 5"
                            StrokeThickness="0"
                            BackgroundColor="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"
                            HeightRequest="30" WidthRequest="5"
                            VerticalOptions="Center"
                            Grid.RowSpan="2" Grid.Column="0"/>

                    <Label Text="{Binding Title}"
                           Style="{StaticResource TaskTitleStyle}"
                           Grid.Row="0" Grid.Column="1"/>

                    <Button Text="{Static fonts:FluentUI.checkmark_20_regular}"
                            FontFamily="FluentUI" FontSize="16"
                            BackgroundColor="Transparent" TextColor="#28a745"
                            HeightRequest="40" WidthRequest="40" Padding="0" Margin="0"
                            BorderWidth="0"
                            CornerRadius="20"
                            VerticalOptions="Center"
                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=MarkTaskDoneCommand}"
                            CommandParameter="{Binding .}"
                            Grid.RowSpan="2" Grid.Column="2">
                        <Button.IsEnabled>
                            <MultiBinding Converter="{StaticResource FutureRepeatingTaskIsEnabledConverter}">
                                <Binding Path="TimeType" />
                                <Binding Path="DueDate" />
                            </MultiBinding>
                        </Button.IsEnabled>
                    </Button>

                    <Label Style="{StaticResource TaskDetailStyle}"
                           Grid.Row="1" Grid.Column="1">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="{Binding ., Converter={StaticResource TaskTimeToStringConverter}}"/>
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>
                </Grid>
            </Frame>
        </DataTemplate>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto" BackgroundColor="{StaticResource PageBackgroundColor}">

        <ProgressBar Grid.Row="0"
                     Progress="{Binding TaskCompletionProgress}"
                     ProgressColor="{Binding TaskCompletionProgress, Converter={StaticResource ProgressToColorConverter}}"
                     HeightRequest="4"
                     Margin="0,0,0,0" />

        <Grid Grid.Row="1" ColumnDefinitions="*,Auto,Auto" Padding="15,10,15,5" BackgroundColor="{StaticResource HeaderBackgroundColor}">
            <Label Text="Tickly Tasks"
                   FontSize="24" FontAttributes="Bold" TextColor="{StaticResource HeaderTextColor}"
                   VerticalOptions="Center"/>

            <Picker Grid.Column="1" Title="Sort By..."
                    ItemsSource="{Binding SortOptionsDisplay}"
                    SelectedItem="{Binding SelectedSortOption}"
                    FontSize="12" VerticalOptions="Center"
                    Margin="0,0,5,0" TextColor="{StaticResource DefaultTextColor}"/>

            <Button Grid.Column="2" Text="{Static fonts:FluentUI.settings_20_regular}"
                    FontFamily="FluentUI" FontSize="18"
                    BackgroundColor="Transparent" TextColor="{StaticResource HeaderTextColor}"
                    Command="{Binding Source={RelativeSource AncestorType={x:Type Shell}}, Path=GoToAsyncCommand}"
                    CommandParameter="SettingsPage"
                    VerticalOptions="Center"
                    HeightRequest="30" WidthRequest="30" Padding="0"/>
        </Grid>

        <CollectionView Grid.Row="2"
                        ItemsSource="{Binding Tasks}"
                        ItemTemplate="{StaticResource TaskItemTemplate}"
                        SelectionMode="None"
                        CanReorderItems="True"
                        VerticalOptions="FillAndExpand">
            <CollectionView.EmptyView>
                <StackLayout Padding="20" VerticalOptions="Center" HorizontalOptions="Center">
                    <Label Text="No tasks yet!" HorizontalTextAlignment="Center" FontSize="18" TextColor="#6c757d"/>
                    <Label Text="Tap the '+' button to add your first task." HorizontalTextAlignment="Center" FontSize="14" TextColor="#adb5bd"/>
                </StackLayout>
            </CollectionView.EmptyView>
        </CollectionView>

        <Button Grid.Row="3" Text="{Static fonts:FluentUI.add_24_regular}"
                FontFamily="FluentUI" FontSize="24"
                BackgroundColor="{StaticResource AccentColor}" TextColor="White"
                CornerRadius="28" HeightRequest="56" WidthRequest="56"
                HorizontalOptions="End" VerticalOptions="End"
                Margin="0,0,20,20"
                Command="{Binding NavigateToAddPageCommand}"
                AbsoluteLayout.LayoutFlags="PositionProportional"
                AbsoluteLayout.LayoutBounds="1,1,-1,-1"/>
    </Grid>

</ContentPage>