<?xml version="1.0" encoding="utf-8" ?>
<!-- MainPage.xaml -->
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Tickly.ViewModels"
             xmlns:models="clr-namespace:Tickly.Models"
             xmlns:converters="clr-namespace:Tickly.Converters"
             x:Class="Tickly.MainPage"
             BackgroundColor="Black"
             Title="Tickly Tasks">

    <!-- Set the BindingContext to the MainViewModel -->
    <ContentPage.BindingContext>
        <vm:MainViewModel />
    </ContentPage.BindingContext>

    <!-- Define page-level resources like converters -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:PriorityToColorConverter x:Key="PriorityColorConverter" />
            <converters:TaskTimeToStringConverter x:Key="TaskTimeConverter" />
            <!-- Ensure Primary color is defined globally in App.xaml or here -->
            <!-- <Color x:Key="Primary">#512BD4</Color> -->
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Main layout grid -->
    <Grid RowDefinitions="*" ColumnDefinitions="*">

        <!-- Task List using CollectionView -->
        <CollectionView ItemsSource="{Binding Tasks}"
                        CanReorderItems="True"
                        Margin="15,10"
                        SelectionMode="None">
            <!-- Comment moved outside: Enables drag-and-drop reordering -->
            <!-- Comment moved outside: We handle taps manually -->

            <CollectionView.ItemTemplate>
                <!-- Define how each task item looks -->
                <DataTemplate x:DataType="models:TaskItem">
                    <!-- Wrap the item content in a Grid to attach the gesture recognizer -->
                    <Grid Padding="10, 8">
                        <Grid.GestureRecognizers>
                            <!-- Tap gesture to navigate to the edit page -->
                            <TapGestureRecognizer
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=NavigateToEditPageCommand}"
                                CommandParameter="{Binding .}" />
                            <!-- CommandParameter sends the current TaskItem -->
                        </Grid.GestureRecognizers>

                        <!-- Original Item Layout (now inside the tappable Grid) -->
                        <Grid ColumnSpacing="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <!-- For priority indicator -->
                                <ColumnDefinition Width="*" />
                                <!-- For text content -->
                            </Grid.ColumnDefinitions>

                            <!-- Priority Indicator (Colored Circle) -->
                            <Frame Grid.Column="0"
                                   HeightRequest="12"
                                   WidthRequest="12"
                                   CornerRadius="6"
                                   BackgroundColor="{Binding Priority, Converter={StaticResource PriorityColorConverter}}"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Center"
                                   BorderColor="Transparent"
                                   Padding="0"
                                   Margin="0,5,0,0"/>
                            <!-- Self-closing tag added above -->
                            <!-- Comment moved outside: Added slight top margin for better alignment -->

                            <!-- Task Title and Time -->
                            <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                                <Label Text="{Binding Title}"
                                       TextColor="White"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       VerticalOptions="Center" />
                                <!-- Self-closing tag added above -->
                                <Label Text="{Binding ., Converter={StaticResource TaskTimeConverter}}"
                                       TextColor="Gray"
                                       FontSize="12"
                                       VerticalOptions="Center" />
                                <!-- Self-closing tag added above -->
                            </VerticalStackLayout>
                        </Grid>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <!-- View to display when the task list is empty -->
            <CollectionView.EmptyView>
                <StackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="20" Spacing="5">
                    <Label Text="No tasks yet!"
                           TextColor="Gray"
                           FontSize="16"
                           HorizontalTextAlignment="Center"/>
                    <!-- Self-closing tag added above -->
                    <Label Text="Click the '+' button to add one."
                           TextColor="Gray"
                           FontSize="14"
                           HorizontalTextAlignment="Center"/>
                    <!-- Self-closing tag added above -->
                </StackLayout>
            </CollectionView.EmptyView>

        </CollectionView>

        <!-- Add Task Button (Floating Action Button style) -->
        <Button Grid.Row="0" Grid.Column="0"
                Text="+"
                FontSize="24"
                FontAttributes="Bold"
                TextColor="Black"
                BackgroundColor="{StaticResource Primary}"
                CornerRadius="28"
                HeightRequest="56"
                WidthRequest="56"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="20"
                Command="{Binding NavigateToAddPageCommand}"
                SemanticProperties.Hint="Add a new task"/>
        <!-- Self-closing tag added above -->
        <!-- Comment moved outside: Position bottom-right -->
        <!-- Comment moved outside: Padding from edges -->
        <!-- Comment moved outside: No VisualStateManager needed here if defined in Styles.xaml -->

    </Grid>
</ContentPage>